<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="assets/stacksworth_logo_icon.png" type="image/png">
  <title>üöÄ STACKSWORTH Web Flasher | Flash Your ‚Çøitcoin Dashboard in Seconds</title>


  <script src="libs/bundle.js"></script>


  <!-- Debug logs to verify ESPLoader and WebSerialTransport -->
  <script type="module">
    console.log("window.ESPLoader:", window.ESPLoader);
    console.log("window.WebSerialTransport:", window.WebSerialTransport);
  </script>
  

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0b0f14;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    .navbar .tabs span {
      margin: 0 10px;
      cursor: pointer;
      font-size: 14px;
      color: #00f6ff;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .header h1 {
      font-size: 42px;
      margin-bottom: 10px;
    }
    .header p {
      font-size: 16px;
      color: #ccc;
    }
    .grid-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .column {
      flex: 1 1 45%;
      background: #121820;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
      min-width: 300px;
    }
    .footer {
      margin-top: 20px;
      background: #121820;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
      text-align: center;
    }
    .footer small {
      display: block;
      margin-top: 15px;
      font-size: 12px;
      color: #888;
    }
    
    h2 {
      text-align: center;  
    }

    .outline-btn {
      background: transparent;
      border: 2px solid #fca420;
      color: #fca420;
      font-weight: bold;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: auto;
      min-width: 220px;
    }
    .outline-btn:hover {
      background-color: rgba(252, 164, 32, 0.1);
    }

    
    input[type="text"],
    input[type="password"], 
    select {
      background-color: #121820;
      border: 2px solid #333;
      color: #fff;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      width: 95%;
      max-width: 450px;
      margin: 10px auto;
      display: block;
      transition: all 0.2s ease-in-out;
    }
    input::placeholder {
      color: #fca420;
      opacity: 0.7;
    }
    input:focus, select:focus {
      border-color: #fca420;
      outline: none;
      background-color: #262626;
    }
    button {
      background: #121820;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #ff8c00;
    }
    .log-container {
      background: #121820;
      padding: 10px;
      border-radius: 5px;
      height: 200px;
      overflow-y: scroll;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .popup {
      display: none;
      position: fixed;
      background: #222;
      color: #fff;
      padding: 20px;
      box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      border-radius: 10px;
    }
    .popup.show {
      display: block;
    }
    .popup .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      color: #fca420;
      font-size: 20px;
    }
    .popup ol li::marker {
      color: #fca420;
    }
    .popup li {
      margin-bottom: 10px;
      line-height: 1.6em;
    }
      /* üîÅ Blinking Erase Progress Indicator */
    #erasingIndicator {
      margin-top: 10px;
      font-size: 14px;
      color: #fca420;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    #erasingIndicator {
      margin-top: 10px;
      font-size: 16px;
      color: #fca420;
      animation: blink 1s infinite;
      font-weight: bold;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.1; }
      100% { opacity: 1; }
    }
  
  </style>
</head>
<body>
  <div class="navbar">
    <div class="tabs">
      <img src="assets/stacksworth_logo_icon.png" alt="Logo" style="height: 24px; margin-right: 8px; vertical-align: middle;">
      <span onclick="togglePopup('start')">Getting Started</span>
      <span>Language ‚ñæ</span>
      <span id="themeToggle" onclick="toggleTheme()">üåô</span>
      <span onclick="togglePopup('socials')">Contact / Socials</span>
    </div>
  </div>

  <div class="popup" id="start" style="top: 50px; left: 20px; width: 280px;">
    <div class="close" onclick="togglePopup('start')">‚úñ</div>
    <h3>Getting Started</h3>
    <ol>
      <li>üîå Connect your STACKSWORTH device via USB</li>
      <li>üì≤ Select your STACKSWORTH model</li>
      <li>üì∂ Enter Wi-Fi and location configuration</li>
      <li>‚ö° Flash the correct firmware</li>
      <li>‚úÖ Done! Your device is ready üöÄ</li>
    </ol>
    <p style="font-size: 12px; margin-top: 20px;">More detailed setup guide available at:<br><a href="#" target="_blank" style="color:#fca420;">github.com/BitcoinManor/stacksworth-setup</a></p>
  </div>

  <div class="popup" id="socials" style="top: 50px; left: 50%; transform: translateX(-50%); width: 300px;">
    <div class="close" onclick="togglePopup('socials')">‚úñ</div>
    <h3>Connect With Us</h3>
    <p>
      <a href="https://x.com/BitcoinManor" target="_blank" style="color:#fca420;">‚ùå Bitcoin Manor</a><br>
      <a href="https://x.com/stacksworth" target="_blank" style="color:#fca420;">‚ùå STACKSWORTH</a><br>
      <a href="https://www.instagram.com/bitcoinmanor/" target="_blank" style="color:#fca420;">üì∏ Bitcoin Manor</a><br>
      <a href="https://www.instagram.com/stacksworth/" target="_blank" style="color:#fca420;">üì∏ STACKSWORTH</a><br>
      <a href="https://bitcoinmanor.com" target="_blank" style="color:#fca420;">üåê bitcoinmanor.com</a><br>
      <a href="https://stacksworth.com" target="_blank" style="color:#fca420;">üåê stacksworth.com</a><br>
      üìß stacksworth@bitcoinmanor.com
    </p>
  </div>
  
  <div class="header">
    <h1>
      <img src="assets/stacksworth_logo.png" alt="STACKSWORTH" style="height: 75px; vertical-align: middle; margin-right: 21px;">
      Web Flasher
    </h1>
    <p>‚ú® Plug in your STACKSWORTH Unit. Select your Model. Flash the Firmware. Your ‚Çøitcoin Journey Begins! ‚ú®</p>

  </div>

  <div class="grid-container">
    <div class="column">
      <h2>1Ô∏è‚É£ Connect Your Device</h2>
      <button class="outline-btn" onclick="connectDevice()">üîå Connect to Device</button>
      <select id="deviceModel" onchange="updateFirmwareOptions()" disabled>
        <option value="Matrix">Matrix</option>
        <option value="Spark">Spark</option>
        <option value="Pulse">Pulse</option>
        <option value="Edge">Edge</option>
        <option value="Infinity">Infinity</option>
      </select>
      <p id="deviceStatus">üî¥ Not Connected</p>

      
      <h2>2Ô∏è‚É£ Erase or Reconnect</h2>
    <button class="outline-btn" onclick="eraseFirmware()">
        üóëÔ∏è Erase Firmware
    </button>

    <button class="outline-btn" onclick="window.location.reload();">
      üîÅ Reconnect
  </button>

      
  </div>

  <div class="column">
      <h2>3Ô∏è‚É£ Configure Device</h2>
     
      <input type="text" id="wifiSSID" placeholder="Wi-Fi SSID">
      <input type="password" id="wifiPassword" placeholder="Wi-Fi Password">
      <input type="text" id="city" placeholder="City (for Weather)">
      <select id="timezone">
        <option value="America/Denver">Mountain Time (MST/MDT)</option>
        <option value="America/New_York">Eastern Time (EST/EDT)</option>
        <option value="America/Los_Angeles">Pacific Time (PST/PDT)</option>
        <option value="UTC">UTC (Universal Time)</option>
        <option value="Europe/London">London (GMT/BST)</option>
        <option value="Europe/Berlin">Berlin (CET/CEST)</option>
        <option value="Asia/Tokyo">Tokyo (JST)</option>
        <option value="Asia/Kolkata">India Standard Time (IST)</option>
        <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
      </select>
    <button class="outline-btn" onclick="saveConfig()">
      üíæ Save Configuration
  </button>


      <h2>4Ô∏è‚É£ ‚ö°Flash Firmware‚ö°</h2>
      <select id="firmwareVersion"></select>
      <button class="outline-btn" onclick="uploadFirmware()">
        ‚ö° Flash Firmware
    </button>

    </div>
  </div>

  <div class="header">
    <h2>Console Output</h2>
    <div class="log-container" id="log"></div>
    <button onclick="downloadLog()" class="small-button">Download Log</button>
  </div>

  <div class="footer">
    <small>¬© 2025 STACKSWORTH Web Flasher. All rights reserved. Maintained by Bitcoin Manor.</small>
  </div>


  
  <script type="module">
    const ESPLoader = window.ESPLoader;
    const WebSerialTransport = window.WebSerialTransport;





    
    function togglePopup(id) {
      document.getElementById(id).classList.toggle("show");
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle("light-mode");
      document.body.style.backgroundColor = isDark ? "#fff" : "#1a1a1a";
      document.body.style.color = isDark ? "#000" : "#fff";
      document.getElementById("themeToggle").innerText = isDark ? "‚òÄÔ∏è" : "üåô";
    }


    // Initialize the device variable to store the connected device
    // This will be used to manage the connection and disconnection of the device
    let device;

async function connectDevice() {
  try {
    device = await navigator.serial.requestPort();  // ‚úÖ Only this line remains

        document.getElementById("deviceStatus").innerText = "üü¢ Connected";
        // ‚úÖ Enable model dropdown
        const modelDropdown = document.getElementById("deviceModel");
        if (modelDropdown) {
          modelDropdown.disabled = false;
          log("Model selector enabled.");
      }

        log("üîå Connected to ‚Çø STACKSWORTH ‚Çø device.");
        console.log("Device object:", device); // Debug log for the device object
      } catch (error) {
        log("Failed to connect to device.");
        console.error(error); // Log the error for debugging
      }
   }




  // Function to erase firmware
  // This function will be called when the "Erase Firmware" button is clicked
async function eraseFirmware() {
  console.log("Device object:", device); // Debug log for the device
  console.log("ESPLoader:", typeof ESPLoader); // Debug log for ESPLoader
  console.log("WebSerialTransport:", typeof WebSerialTransport); // ‚úÖ


  if (!ESPLoader || !WebSerialTransport) {
    log("‚ùå esptool-js not loaded. Please check the script source.");
    return;
  }

  if (!device) {
    log("‚ùå No device connected. Connect first!");
    return;
  }

  log("Erasing firmware...");

    const indicator = document.createElement("div");
    indicator.id = "erasingIndicator";
    indicator.textContent = "‚Çø üß® Purging firmware... üï≥Ô∏è Entering the matrix.";
    document.getElementById("log").appendChild(indicator);

  

  try {
    const transport = new WebSerialTransport(device); // ‚úÖ Construct transport

    // üß™ Debugging logs ‚Äî right after transport is created
    console.log("üß™ Debug: Transport object:", transport);
    console.log("üß™ Debug: transport.getInfo exists?", typeof transport.getInfo);
    console.log("üß™ Debug: getInfo call result:", transport?.getInfo?.());

    // Then continue as usual
    const esploader = new ESPLoader({ transport: transport, baudrate: 115200 });
    console.log("Transport and ESPLoader initialized:", transport, esploader);

    console.log("üì° Starting ESPLoader connect...");
    

    await esploader.connect();
    console.log("üîó Connected. Proceeding to initialize...");

    log("üí• Initiating open-source sovereignty protocol...");


    await esploader.eraseFlash();
    console.log("Flash erased.");
    log("‚öôÔ∏è Initial erase complete! You're ready to flash your firmware.");
    log("üëâ Proceed to Step 4Ô∏è‚É£ and select your firmware version.");


    await transport.disconnect();
    console.log("Transport disconnected.");

    document.getElementById("erasingIndicator")?.remove();


    log("‚úî Firmware erased successfully!");
  } catch (error) {
    log("‚ùå Error erasing firmware: " + error.message);
    console.error("Error erasing firmware:", error);
  }
}


  // Function to upload firmware
  // This function will be called when the "Flash Firmware" button is clicked
  // It will download the firmware from the selected URL and upload it to the device
async function uploadFirmware() {
  console.log("Device object:", device); // Debug log for the device
  console.log("ESPLoader:", typeof ESPLoader); // Debug log for ESPLoader
  console.log("WebSerialTransport:", typeof WebSerialTransport); // ‚úÖ


  if (!ESPLoader || !WebSerialTransport) {
    log("‚ùå esptool-js not loaded. Please check the script source.");
    return;
  }

  if (!device) {
    log("‚ùå No device connected. Connect first!");
    return;
  }

  const firmwareUrl = document.getElementById("firmwareVersion").value;
  log("Downloading firmware...");

  try {
    console.log("Firmware URL:", firmwareUrl); // Debug log for the firmware URL
    const response = await fetch(firmwareUrl);
    const firmwareData = await response.arrayBuffer();
    console.log("Firmware downloaded:", firmwareData);

    log("Uploading firmware to device ‚Çø...");
    const transport = new WebSerialTransport(device); // ‚úÖ Construct transport

    // üß™ Debugging logs ‚Äî right after transport is created
    console.log("üß™ Debug: Transport object:", transport);
    console.log("üß™ Debug: transport.getInfo exists?", typeof transport.getInfo);
    console.log("üß™ Debug: getInfo call result:", transport?.getInfo?.());

    // Then continue as usual
    const esploader = new ESPLoader({ transport: transport, baudrate: 115200 });
    console.log("Transport and ESPLoader initialized:", transport, esploader);

    console.log("üöÄ Starting flash process (‚ö°Connecting your ‚Çøitcoin Journey!!)...");

  if (!device.readable || !device.writable) {
    await transport.connect();
    console.log("Transport connected.");
  } else {
    console.log("üîÅ Serial port already open. Skipping transport.connect().");
}


    await esploader.connect();
    console.log("ESPLoader initialized.");

    log("üí• Initiating open-source sovereignty protocol...");

    await esploader.flashData(new Uint8Array(firmwareData));
    console.log("Firmware flashed.");

    console.log("‚úÖ Flash Complete, ‚Çø Journey about to begin!.");

    await transport.disconnect();
    console.log("Transport disconnected.");

    log("‚Çø Self-sovereign mode enabled, Firmware uploaded successfully!");
  } catch (error) {
    log("‚ùå Error uploading firmware: " + error.message);
    console.error("Error uploading firmware:", error);
  }
}


    // Function to save configuration
    // This function will be called when the "Save Configuration" button is clicked
    function saveConfig() {
      const config = {
        wifiSSID: document.getElementById("wifiSSID").value,
        wifiPassword: document.getElementById("wifiPassword").value,
        city: document.getElementById("city").value,
        timezone: document.getElementById("timezone").value,
        deviceModel: document.getElementById("deviceModel").value
      };

      // Log the saved configuration to the console
      console.log("Configuration saved:", config);
      log("‚úî Configuration saved successfully!");

      // Log the configuration to the UI
      log("\nConfig saved: " + JSON.stringify(config, null, 2));
    }


    // Function to update firmware options based on the selected device model
    // This function will be called when the device model is changed in the dropdown
    function updateFirmwareOptions() {
      const model = document.getElementById("deviceModel").value;
      const firmwareDropdown = document.getElementById("firmwareVersion");
      firmwareDropdown.innerHTML = "";

      const firmwareOptions = {
        Matrix: [
          { name: "STACKSWORTH Matrix v1.1", url: "https://bitcoinmanor.github.io/BlokdBit-Matrix/BlokdBit_Matrix_FINAL_SKETCH4Flasher.ino.nodemcu-32s.bin" }
        ],
        Spark: [{ name: "STACKSWORTH Spark Beta", url: "https://example.com/spark-firmware.bin" }],
        Pulse: [],
        Edge: [],
        Infinity: []
      };

      firmwareOptions[model].forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.url;
        option.text = opt.name;
        firmwareDropdown.appendChild(option);
      });
    }

    function log(message) {
      const logContainer = document.getElementById("log");
      logContainer.innerText += message + "\n";
      logContainer.scrollTop = logContainer.scrollHeight;
    }

     function downloadLog() {
      const logContent = document.getElementById("log").innerText;
      const blob = new Blob([logContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stacksworth_log.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = () => updateFirmwareOptions();
    window.uploadFirmware = uploadFirmware;
    window.eraseFirmware = eraseFirmware;
    window.connectDevice = connectDevice;
    window.togglePopup = togglePopup;
    window.toggleTheme = toggleTheme;
    window.saveConfig = saveConfig;
    window.updateFirmwareOptions = updateFirmwareOptions;
    window.downloadLog = downloadLog;

  </script>
</body>
</html>
